<!doctype html>
<html>
  <head>
    <title>My experiment</title>
        <script src="/static/lib/jquery-min.js" type="text/javascript"></script>
        <script src="/static/lib/bootstrap.min.js" type="text/javascript"></script>
        <script src="/static/lib/underscore-min.js" type="text/javascript"></script>
        <script src="/static/lib/backbone-min.js" type="text/javascript"></script>
        
        <script src="/static/js/myjspsych/jspsych.js" type="text/javascript"></script>
        <script src="/static/js/myjspsych/plugins/jspsych-text.js" type="text/javascript"></script>
        <script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.10.3/jquery-ui.min.js"></script>
        <script src="/static/js/myjspsych/plugins/jspsych-similarity.js" type="text/javascript"></script>
        <script src="/static/js/myjspsych/plugins/jspsych-custom-triplet.js" type="text/javascript"></script>
        <script src="/static/js/myjspsych/plugins/jspsych-text.js" type="text/javascript"></script>
        <script src="/static/js/myjspsych/plugins/jspsych-survey-select.js" type="text/javascript"></script>
        <script src="/static/js/myjspsych/plugins/jspsych-survey-text.js" type="text/javascript"></script>
        <script src="/static/js/myjspsych/plugins/jspsych-survey-new.js" type="text/javascript"></script>
        <script src="/static/js/myjspsych/plugins/jspsych-call-function.js" type="text/javascript"></script>
        
        <script type="text/javascript">
            // These fields provided by the psiTurk Server
            var uniqueId = "{{ uniqueId }}"; // a unique string identifying the worker/task
            var adServerLoc = "{{ adServerLoc }}"; // the location of your ad (so you can send user back at end of experiment)
            var mode = "{{ mode }}"; // is this running live, sandbox, or in debug mode?
        </script>
        
        <!-- utils.js and psiturk.js provide the basic psiturk functionality -->
        <script src="/static/js/utils.js" type="text/javascript"></script>
        <script src="/static/js/psiturk.js" type="text/javascript"></script>
        
        <link href="/static/js/myjspsych/css/jspsych.css" rel="stylesheet" type="text/css"></link>
        <link href="/static/css/style.css" rel="stylesheet" type="text/css"></link>
        <link href="/static/css/bootstrap.min.css" rel="stylesheet" type="text/css"></link>
        <link href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.10.3/themes/black-tie/jquery-ui.min.css" rel="stylesheet" type="text/css"></link>
  </head>
  <body>
    <audio id="pleasant"><source src='/static/sound/pleasant.mp3' type="audio/mpeg"></audio>
    <audio id="warning"><source src='/static/sound/alert.mp3' type="audio/mpeg"></audio>
    <div id="jspsych_target" class="jspsych_target"></div>
  </body>
  <script>
    function getAverageResponseTime() {

      var trials = jsPsych.data.getTrialsOfType('single-stim');

      var sum_rt = 0;
      var valid_trial_count = 0;
      for (var i = 0; i < trials.length; i++) {
        if (trials[i].response == 'go' && trials[i].rt > -1) {
          sum_rt += trials[i].rt;
          valid_trial_count++;
        }
      }
      return Math.floor(sum_rt / valid_trial_count);
    }

    function shuffle(o){
        for(var j, x, i = o.length; i; j = Math.floor(Math.random() * i), x = o[--i], o[i] = o[j], o[j] = x);
        return o;
    }

    // Input: gender = 'F' / 'M'
    // Output: images of specified gener in folder static/images/EclipseFace
    function getAllImages_EclipseFace (gender, maxnum) {
      images = [];
      for (i = 1; i < maxnum + 1; ++i){
        images.push('/static/images/EclipseFace/' + gender + i + '.png');
      }
      return images;
    }

    function generateUniqueRandomNums(numrands, start, end){
      var pool = [];
      for (i = start; i < end; ++i){
        pool[i] = i;
      }
      randlist = [];
      for (i = 0; i < numrands; ++i){
        var index = Math.floor(pool.length * Math.random());
        var drawn = pool.splice(index, 1);
        randlist.push(drawn);
      }
      return randlist;
    }

    // Input: number of images used in the whole stimuli
    // Output: array containing doublets of stimuli. Each pair 
    //   does not occur more than once (regardless of the order of 
    //   both images), and each pair does not contain the same image.
    function getDoubletStimuli_EclipseFace (gender, num, numcatch) {
      stimuli = [];
      allimages = getAllImages(gender, num);
      for (i = 0; i < allimages.length; ++i){
        for (j = i + 1; j < allimages.length; ++j){
          stimuli.push([allimages[i], allimages[j]]);
        }
      }
      if (numcatch != 0){
        randlist = generateUniqueRandomNums(numcatch, 10, stimuli.length);

      }
      return stimuli;
    }

    function getTripletStimuli_EclipseFace (gender, num, numcatch) {
      stimuli = [];
      allimages = getAllImages(gender, num);
      for (i = 0; i < allimages.length; ++i){
        for (j = i + 1; j < allimages.length; ++j){
          for (k = j + 1; k < allimages.length; ++k){
            arr = [allimages[i], allimages[j], allimages[k]];
            jsPsych.randomization.shuffle(arr)
            stimuli.push(arr);
          }
        }
      }
      console.log(stimuli.length);
      return stimuli;
    }

    function getAllImages (gender, maxnum) {
      images = [];
      if (gender == 'F'){
        gender = 'female'
      } else {
        gender = 'male'
      }
      for (i = 1; i < maxnum + 1; ++i){
        images.push('/static/images/2kfaces_' + gender + '/' + i + '.jpg');
      }
      return images;
    }

    function getDoubletStimuli (gender, num, numcatch) {
      stimuli = [];
      allimages = getAllImages(gender, num);
      for (i = 0; i < allimages.length - 1; i += 2){
        stimuli.push([allimages[i], allimages[i + 1]]);
      }
      if (numcatch != 0){
        randlist = generateUniqueRandomNums(numcatch, 10, stimuli.length);

      }
      return stimuli;
    }

    function getTripletStimuli (gender, num, numcatch) {
      stimuli = [];
      allimages = getAllImages(gender, num);
      for (i = 0; i < allimages.length - 2; i += 3){
        arr = [allimages[i], allimages[i + 1], allimages[i + 2]];
        jsPsych.randomization.shuffle(arr)
        stimuli.push(arr);
      }
      console.log(stimuli.length);
      return stimuli;
    }

    var post_trial_gap = function() {
      return Math.floor( Math.random() * 750 ) + 250;
    }

    var question_age = ["How old are you?"];
    /*var welcome_survey_age_block = {
      type: "survey-text",
      //text: "<p> Please </p>",
      questions: [question_age],
    };*/
    var welcome_survey_new_block = {
      type: "survey_new",
      questions: [question_age],
      text: "<div class='jspsych_target jspsych-display-element'> <div class='jspsych-survey-likert-preamble'></div> <div class='jspsych-survey-text-question'> <p class='jspsych-survey-text'> Please fill out this short survey </p> <br> </br> <p class='jspsych-survey-text'> <!--My gender is--></p> <select id='gender' name='gender' class='qstn-select'> <option value='empty'> My gender is </option> <option value='Male'>Male</option> <option value='Female'>Female</option> </select> </div> <div class='jspsych-survey-text-question'> <p class='jspsych-survey-text'><!--My ethnicity is--> </p> <select id='demographic' name='demographic' class='qstn-select'> <option value='empty'> My ethnicity is</option> <option value='white'> White</option> <option value='hispanic'> Hispanic or Latino</option> <option value='african'> Black or African American</option> <option value='indian'> Native American or American Indian</option> <option value='asian'> Asian / Pacific Islander</option> <option value='other'> Other</option> </select> </div> <div class='jspsych-survey-text-question'> <p class='jspsych-survey-text'><!--My sexual orientation is --></p> <select id='demographic' name='demographic' class='qstn-select'> <option value='empty'> My sexual orientation is </option> <option value='bisexual'> Bisexual</option> <option value='heterosexual'> Heterosexual</option> <option value='homosexual'> Homosexual</option> <option value='other'> Other</option> </select> </div> <div class='jspsych-survey-text-question'> <p class='jspsych-survey-text'><!--My handedness is--> </p> <select id='handedness' name='handedness' class='qstn-select'> <option value='empty'> My handedness is</option> <option value='right'> Right-handedness</option> <option value='left'> Left-handedness</option> <option value='mixed'> Mixed-handedness</option> </select> </div> </div>"
    };
    /*var welcome_survey_block = {
      type: "survey_select",
      text: "<div class='jspsych_target jspsych-display-element'> <div class='jspsych-survey-likert-preamble'></div> <div class='jspsych-survey-text-question'> <p class='jspsych-survey-text'>Your gender is</p> <select id='gender' name='gender' class='qstn-select'> <option value='empty'>Your gender is</option> <option value='Male'>Male</option> <option value='Female'>Female</option> </select> </div> <div class='jspsych-survey-text-question'> <p class='jspsych-survey-text'>Please specify your ethnicity</p> <select id='demographic' name='demographic' class='qstn-select'> <option value='empty'> Please specify your ethnicity</option> <option value='white'> White</option> <option value='hispanic'> Hispanic or Latino</option> <option value='african'> Black or African American</option> <option value='indian'> Native American or American Indian</option> <option value='asian'> Asian / Pacific Islander</option> <option value='other'> Other</option> </select> </div> <div class='jspsych-survey-text-question'> <p class='jspsych-survey-text'>Indicate your handedness</p> <select id='handedness' name='handedness' class='qstn-select'> <option value='empty'> Indicate your handedness</option> <option value='right'> Right-handedness</option> <option value='left'> Left-handedness</option> <option value='mixed'> Mixed-handedness</option> </select> </div> <br/><br/> <p class='jspsych-survey-text'>Press any key to continue.</p></div>"
    };*/

    /* define welcome message block */
    var instruction1_block = {
      type: "text",
      text: "<div><h1>Instruction (1/3)</h1> <hr> <div class='well'> <p>In this experiment, you will see many faces and your task is to compare and judge face similarities.</p> <p>There are two types of tasks: face pair task and face triplet task</p> <div class='row'> <div class='col-md-6'> <h5><b>Face Pair Task</b></h5> <p>Rate the similarity level of the face pair from 1 to 9.</p> <p>1 -- Maximally dissimilar, 9 -- Maximally similar</p> <img src='/static/images/instru-p1.png' style='width:100%'/> </div> <div class='col-md-6'> <h5><b>Face Triplet Task</b></h5> <p>Decide which of the two face images is more similar to each other. You can click on the face image to indicate your choice.</p> <img src='/static/images/instru-p2.png' style='width:100%'/> </div> </div></div></div>"
    };

    var instruction2_block = {
      type: "text",
      text: "<div><h1>Instruction (2/3)</h1> <hr> <div class='well' > <p>The whole experiment will last approximately 30 mins. The timeline is as follows. <div style='text-align:center;''> <img src='/static/images/instru-p3_new.png' style='width:100%'/> </div></div></div>"
    };

    var instruction3_block = {
      type: "text",
      text: '<div><h1>Instructions (3/3)</h1> <hr> <div class="well" > <p>Each presentation will remain on the screen for 0.5 seconds before you can start to respond. After choice bottoms appear, indicate your choice as fast as you can, in no more than 3 seconds. You will see the next page after indicating your choice.</p> <p>If you respond too fast or too slow, you will hear a warning sound.</p> <p>Between the tasks, you will have a 1 min break.</p> <br/> <p>You will enter the practice session after this page. Press "Continue" to start your practice. Press "Back" to return to previous instruction pages.</p> </div></div>'
    };

    var prac1_ready_block = {
      type: "text",
      text: '<div><strong>Judging face similarities</strong> <hr> <div class="well">  <p>You will be presented with a series of pairs of face images.  You will be judging the similarities between them.</p>  <p>Click the "Continue" button below to practice a couple of times.</p>  <p>In the first example, you will be asked to rate the similarity level of the face pair from 1 to 9.</p> <p>1 -- Maximally Dissimilar, 9 -- Maximally Similar</p> <br></div></div>',
        //"<p>Press any key to begin the practice for Doublet experiment.</p>",
      timing_post_trial: post_trial_gap
    };

    var prac2_ready_block = {
      type: "text",
      text: '<div class="well"> <p>Great Job! </p> <p> Next you will do the similar thing, but instead of seeing two faces, you are going to see <strong>three</strong> faces and click on the two images that look more similar to you.</div>',
      timing_post_trial: post_trial_gap
    };
    var prac_no_inst_ready_block = {
      type: "text",
      text: '<div class="well"> <p>Good Job! </p> <p> Practice a few more.</div>',
      timing_post_trial: post_trial_gap
    };
    var test_ready_block = {
      type: "text",
      text: '<div class="well"><p>Terrific! That'+ "'s" +' the end of the pratice trials. Now you will be presented with 200 trials like those you just practiced on, except that you will not receive instructions between trials. </p> <p>Remember, click on the faces that you think are more similar for trials with three faces, or rate the similarities between two faces for trials with two faces.</p> <p>The most important rule, <em> go with your guts!</em></p> <p>Click the button below to begin the experiment.</p></div>',
      timing_post_trial: post_trial_gap
    };

    var break1_block = {
      type: "text",
      text: "<p>You have just finished half of Triplet experiment. You will now begin Doublet experiment.</p>",
      timing_post_trial: post_trial_gap
    };

    var break2_block = {
      type: "text",
      text: "<p>You have just finished Doublet experiment. You will now begin the second half of Triplet experiment.</p>",
      timing_post_trial: post_trial_gap
    };

    var complete_block = {
      type: "text",
      text: "<p>You have just finished the whole experiment. Thank you for your participation.</p>",
      timing_post_trial: post_trial_gap
    };

    /* define test block */

    var prac_doublet_stim = getDoubletStimuli('F', 3);
    var test_doublet_stim = getDoubletStimuli('F', 3);
    var prac_triplet_stim = getTripletStimuli('F', 3);
    var test_triplet_all_stim = getTripletStimuli('F', 5);
    var test_triplet1_stim = test_triplet_all_stim.slice(
      0, test_triplet_all_stim.length / 2);
    var test_triplet2_stim = test_triplet_all_stim.slice(
      test_triplet_all_stim.length / 2);

    jsPsych.randomization.shuffle(prac_doublet_stim);
    jsPsych.randomization.shuffle(test_doublet_stim);
    jsPsych.randomization.shuffle(prac_triplet_stim);
    jsPsych.randomization.shuffle(test_triplet1_stim);
    jsPsych.randomization.shuffle(test_triplet2_stim);


    //practice with instruction blocks
    var prac_doublet_block = {
      type: 'similarity',
      stimuli: prac_doublet_stim,
      labels: ['1', '2', '3', '4', '5', '6', '7','8','9'],
      intervals: 9,
      labelName: ['Maximally Dissimilar','','','','','','','','Maximally Similar'],
      timing_post_trial: post_trial_gap
    };

    var prac_triplet_block = {
      type: 'custom_triplet',
      stimuli: prac_triplet_stim,
      prompt: "Click on the two faces that you think are more similar.",
      timing_post_trial: post_trial_gap
    };


    //practice with no instruction blocks
    var prac_no_inst_doublet_block_1 = {
      type: 'similarity',
      stimuli: prac_doublet_stim,
      labels: ['1', '2', '3', '4', '5', '6', '7','8','9'],
      intervals: 9,
      labelName: ['Maximally Dissimilar','','','','','','','','Maximally Similar'],
      timing_post_trial: post_trial_gap
    };
    var prac_no_inst_doublet_block_2 = {
      type: 'similarity',
      stimuli: prac_doublet_stim,
      labels: ['1', '2', '3', '4', '5', '6', '7','8','9'],
      intervals: 9,
      labelName: ['Maximally Dissimilar','','','','','','','','Maximally Similar'],
      timing_post_trial: post_trial_gap
    };
    
    var prac_no_inst_doublet_block_3 = {
      type: 'similarity',
      stimuli: prac_doublet_stim,
      labels: ['1', '2', '3', '4', '5', '6', '7','8','9'],
      intervals: 9,
      labelName: ['Maximally Dissimilar','','','','','','','','Maximally Similar'],
      timing_post_trial: post_trial_gap
    };
    var prac_no_inst_doublet_block_4 = {
      type: 'similarity',
      stimuli: prac_doublet_stim,
      labels: ['1', '2', '3', '4', '5', '6', '7','8','9'],
      intervals: 9,
      labelName: ['Maximally Dissimilar','','','','','','','','Maximally Similar'],
      timing_post_trial: post_trial_gap
    };
    var prac_no_inst_triplet_block_1 = {
      type: 'custom_triplet',
      stimuli: prac_triplet_stim,
      prompt: "Click on the two faces that you think are more similar.",
      timing_post_trial: post_trial_gap
    };
    var prac_no_inst_triplet_block_2 = {
      type: 'custom_triplet',
      stimuli: prac_triplet_stim,
      prompt: "Click on the two faces that you think are more similar.",
      timing_post_trial: post_trial_gap
    };
    var prac_no_inst_triplet_block_3 = {
      type: 'custom_triplet',
      stimuli: prac_triplet_stim,
      prompt: "Click on the two faces that you think are more similar.",
      timing_post_trial: post_trial_gap
    };
    var prac_no_inst_triplet_block_4 = {
      type: 'custom_triplet',
      stimuli: prac_triplet_stim,
      prompt: "Click on the two faces that you think are more similar.",
      timing_post_trial: post_trial_gap
    };


    //test blocks
    var test_doublet_block = {
      type: 'similarity',
      stimuli: test_doublet_stim,
      labels: ['1', '2', '3', '4', '5', '6', '7','8','9'],
      labelName: ['Maximally Dissimilar','','','','','','','','Maximally Similar'],
      intervals: 9,
      timing_post_trial: post_trial_gap
    };

    var test_triplet1_block = {
      type: 'custom_triplet',
      stimuli: test_triplet1_stim,
      prompt: "Click on the two faces that you think are more similar.",
      timing_post_trial: post_trial_gap
    };

    var test_triplet2_block = {
      type: 'custom_triplet',
      stimuli: test_triplet2_stim,
      prompt: "Click on the two faces that you think are more similar.",
      timing_post_trial: post_trial_gap
    };

    // var test_block = {
    //   type: "single-stim",
    //   stimuli: all_trials.image,
    //   choices: ['F'],
    //   data: all_trials.data,
    //   timing_response: 1500,
    //   timing_post_trial: post_trial_gap
    // };

    /* define debrief block */

    var debrief_block = {
      type: "text",
      text: function() {
        return "<p>Your average response time was <strong>" +
        getAverageResponseTime() + "ms</strong>. Press " +
        "any key to complete the experiment. Thank you!</p>";
      }
    };

    /* create experiment definition array */
    var experiment = [];
    //experiment.push(welcome_survey_age_block);
    //experiment.push(welcome_survey_block);
    experiment.push(welcome_survey_new_block);
    //experiment.push(instruction1_block);
    //experiment.push(instruction2_block);
    //experiment.push(instruction3_block);
    experiment.push(prac1_ready_block);
    experiment.push(prac_doublet_block);
    experiment.push(prac2_ready_block);
    experiment.push(prac_triplet_block);
    experiment.push(prac_no_inst_ready_block);
    experiment.push(prac_no_inst_doublet_block_1);
    experiment.push(prac_no_inst_doublet_block_2);
    experiment.push(prac_no_inst_triplet_block_1);
    experiment.push(prac_no_inst_triplet_block_2);
    experiment.push(prac_no_inst_doublet_block_3);
    experiment.push(prac_no_inst_doublet_block_4);
    experiment.push(prac_no_inst_triplet_block_3);
    experiment.push(prac_no_inst_triplet_block_4);
    experiment.push(test_ready_block);
    experiment.push(test_triplet1_block);
    experiment.push(break1_block);
    experiment.push(test_doublet_block);
    experiment.push(break2_block);
    experiment.push(test_triplet2_block);
    experiment.push(complete_block);
    experiment.push(debrief_block);

    jsPsych.preloadImages(getAllImages('F', 6), start)
    var psiturk = new PsiTurk(uniqueId, adServerLoc, mode);

    /* start the experiment */
    function start() {
      jsPsych.init({
        display_element: $('#jspsych_target'),
        experiment_structure: experiment,
        show_progress_bar: true,
        on_finish: function() {
            psiturk.saveData({
                success: function() { psiturk.completeHIT(); }
            });
        },
        on_data_update: function(data) {
            psiturk.recordTrialData(data);
        }
      });
    }
  </script>
</html>