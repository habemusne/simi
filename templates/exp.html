<!doctype html>
<html>
  <head>
    <title>My experiment</title>
        <script src="/static/lib/jquery-min.js" type="text/javascript"></script>
        <script src="/static/lib/underscore-min.js" type="text/javascript"></script>
        <script src="/static/lib/backbone-min.js" type="text/javascript"></script>
        
        <script src="/static/js/jspsych/jspsych.js" type="text/javascript"></script>
        <script src="/static/js/jspsych/plugins/jspsych-text.js" type="text/javascript"></script>
        <script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.10.3/jquery-ui.min.js"></script>
        <script src="/static/js/jspsych/plugins/jspsych-similarity.js" type="text/javascript"></script>
        <script src="/static/js/jspsych/plugins/jspsych-xab.js" type="text/javascript"></script>
        <script src="/static/js/jspsych/plugins/jspsych-text.js" type="text/javascript"></script>
        <script src="/static/js/jspsych/plugins/jspsych-call-function.js" type="text/javascript"></script>
        
        <script type="text/javascript">
            // These fields provided by the psiTurk Server
            var uniqueId = "{{ uniqueId }}"; // a unique string identifying the worker/task
            var adServerLoc = "{{ adServerLoc }}"; // the location of your ad (so you can send user back at end of experiment)
            var mode = "{{ mode }}"; // is this running live, sandbox, or in debug mode?
        </script>
        
        <!-- utils.js and psiturk.js provide the basic psiturk functionality -->
        <script src="/static/js/utils.js" type="text/javascript"></script>
        <script src="/static/js/psiturk.js" type="text/javascript"></script>
        
        <link href="/static/js/jspsych/css/jspsych.css" rel="stylesheet" type="text/css"></link>
        <link href="/static/css/style.css" rel="stylesheet" type="text/css"></link>
        <link href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.10.3/themes/black-tie/jquery-ui.min.css" rel="stylesheet" type="text/css"></link>
  </head>
  <body>
    <div id="jspsych_target" class="jspsych_target"></div>
  </body>
  <script>
    function getAverageResponseTime() {

      var trials = jsPsych.data.getTrialsOfType('single-stim');

      var sum_rt = 0;
      var valid_trial_count = 0;
      for (var i = 0; i < trials.length; i++) {
        if (trials[i].response == 'go' && trials[i].rt > -1) {
          sum_rt += trials[i].rt;
          valid_trial_count++;
        }
      }
      return Math.floor(sum_rt / valid_trial_count);
    }

    function shuffle(o){
        for(var j, x, i = o.length; i; j = Math.floor(Math.random() * i), x = o[--i], o[i] = o[j], o[j] = x);
        return o;
    }

    // Input: gender = 'F' / 'M'
    // Output: images of specified gener in folder static/images/EclipseFace
    function getAllImages (gender, maxnum) {
      images = [];
      for (i = 1; i < maxnum + 1; ++i){
        images.push('/static/images/EclipseFace/' + gender + i + '.png');
      }
      return images;
    }

    function generateUniqueRandomNums(numrands, start, end){
      var pool = [];
      for (i = start; i < end; ++i){
        pool[i] = i;
      }
      randlist = [];
      for (i = 0; i < numrands; ++i){
        var index = Math.floor(pool.length * Math.random());
        var drawn = pool.splice(index, 1);
        randlist.push(drawn);
      }
      return randlist;
    }

    // Input: number of images used in the whole stimuli
    // Output: array containing doublets of stimuli. Each pair 
    //   does not occur more than once (regardless of the order of 
    //   both images), and each pair does not contain the same image.
    function getDoubletStimuli(gender, num, numcatch) {
      stimuli = [];
      allimages = getAllImages(gender, num);
      for (i = 0; i < allimages.length; ++i){
        for (j = i + 1; j < allimages.length; ++j){
          stimuli.push([allimages[i], allimages[j]]);
        }
      }
      if (numcatch != 0){
        randlist = generateUniqueRandomNums(numcatch, 10, stimuli.length);

      }
      return stimuli;
    }

    function getTripletStimuli(gender, num, numcatch) {
      stimuli = [];
      allimages = getAllImages(gender, num);
      for (i = 0; i < allimages.length; ++i){
        for (j = i + 1; j < allimages.length; ++j){
          for (k = j + 1; k < allimages.length; ++k){
            arr = [allimages[i], allimages[j], allimages[k]];
            jsPsych.randomization.shuffle(arr)
            stimuli.push(arr);
          }
        }
      }
      console.log(stimuli.length);
      return stimuli;
    }

    /* define welcome message block */
    var welcome_block = {
      type: "text",
      text: "Welcome to the experiment. Press any key to begin."
    };

    /* define instructions block */
    var instructions_block = {
      type: "text",
      text: "This is an instruction. Press any key to continue.",
      timing_post_trial: 1000
    };

    var prac1_ready_block = {
      type: "text",
      text: "<p>Press any key to begin the practice for Doublet experiment.</p>",
      timing_post_trial: 1000
    };

    var prac2_ready_block = {
      type: "text",
      text: "<p>The Doublet experiment practice session is over. Press any key to begin the practice for Triplet experiment.</p>",
      timing_post_trial: 1000
    };

    var test_ready_block = {
      type: "text",
      text: "<p>The pratice session is over. Press any key to begin the test.</p>",
      timing_post_trial: 1000
    };

    var break1_block = {
      type: "text",
      text: "<p>You have just finished half of Triplet experiment. You will now begin Doublet experiment.</p>",
      timing_post_trial: 1000
    };

    var break2_block = {
      type: "text",
      text: "<p>You have just finished Doublet experiment. You will now begin the second half of Triplet experiment.</p>",
      timing_post_trial: 1000
    };

    var complete_block = {
      type: "text",
      text: "<p>You have just finished the whole experiment. Thank you for your participation.</p>",
      timing_post_trial: 1000
    };

    /* define test block */

    var prac_doublet_stim = getDoubletStimuli('F', 3);
    var test_doublet_stim = getDoubletStimuli('F', 3);
    var prac_triplet_stim = getTripletStimuli('F', 3);
    var test_triplet_all_stim = getTripletStimuli('F', 5);
    var test_triplet1_stim = test_triplet_all_stim.slice(
      0, test_triplet_all_stim.length / 2);
    var test_triplet2_stim = test_triplet_all_stim.slice(
      test_triplet_all_stim.length / 2);

    jsPsych.randomization.shuffle(prac_doublet_stim);
    jsPsych.randomization.shuffle(test_doublet_stim);
    jsPsych.randomization.shuffle(prac_triplet_stim);
    jsPsych.randomization.shuffle(test_triplet1_stim);
    jsPsych.randomization.shuffle(test_triplet2_stim);

    var prac_doublet_block = {
      type: 'similarity',
      stimuli: prac_doublet_stim,
      labels: ['Maximally Dissimilar', 'Very Dissimilar', 'Dissimilar', 'Indifferent', 'Similar', 'Very Similar', 'Maximally Similar'],
      intervals:7
    };

    var prac_triplet_block = {
      type: 'xab',
      stimuli: prac_triplet_stim,
      left_key: 'L',
      right_key: 'R',
      prompt: "Select the face that is more similar to the top one by pressing 'L' or 'R'."
    };

    var test_doublet_block = {
      type: 'similarity',
      stimuli: test_doublet_stim,
      labels: ['Maximally Dissimilar', 'Very Dissimilar', 'Dissimilar', 'Indifferent', 'Similar', 'Very Similar', 'Maximally Similar'],
      intervals:7
    };

    var test_triplet1_block = {
      type: 'xab',
      stimuli: test_triplet1_stim,
      left_key: 'L',
      right_key: 'R',
      prompt: "Select the face that is more similar to the top one by pressing 'L' or 'R'."
    };

    var test_triplet2_block = {
      type: 'xab',
      stimuli: test_triplet2_stim,
      left_key: 'L',
      right_key: 'R',
      prompt: "Select the face that is more similar to the top one by pressing 'L' or 'R'."
    };

    var post_trial_gap = function() {
      return Math.floor( Math.random() * 1500 ) + 750;
    }

    // var test_block = {
    //   type: "single-stim",
    //   stimuli: all_trials.image,
    //   choices: ['F'],
    //   data: all_trials.data,
    //   timing_response: 1500,
    //   timing_post_trial: post_trial_gap
    // };

    /* define debrief block */

    var debrief_block = {
      type: "text",
      text: function() {
        return "<p>Your average response time was <strong>" +
        getAverageResponseTime() + "ms</strong>. Press " +
        "any key to complete the experiment. Thank you!</p>";
      }
    };

    /* create experiment definition array */
    var experiment = [];
    experiment.push(welcome_block);
    experiment.push(instructions_block);
    experiment.push(prac1_ready_block);
    experiment.push(prac_doublet_block);
    experiment.push(prac2_ready_block);
    experiment.push(prac_triplet_block);
    experiment.push(test_ready_block);
    experiment.push(test_triplet1_block);
    experiment.push(break1_block);
    experiment.push(test_doublet_block);
    experiment.push(break2_block);
    experiment.push(test_triplet2_block);
    experiment.push(complete_block);
    experiment.push(debrief_block);

    jsPsych.preloadImages(getAllImages('F', 6), start)
    var psiturk = new PsiTurk(uniqueId, adServerLoc, mode);

    /* start the experiment */
    function start() {
      jsPsych.init({
        display_element: $('#jspsych_target'),
        experiment_structure: experiment,
        show_progress_bar: true,
        on_finish: function() {
            psiturk.saveData({
                success: function() { psiturk.completeHIT(); }
            });
        },
        on_data_update: function(data) {
            psiturk.recordTrialData(data);
        }
      });
    }
  </script>
</html>